# 爬虫规则 Web 编辑器用户指南

## 概述

Spectra 爬虫规则 Web 编辑器是一个可视化的规则编辑工具，无需手写 JSON 即可创建和管理爬虫规则。

## 访问编辑器

1. 打开 Spectra 应用
2. 进入 **设置** 页面
3. 点击 **规则编辑器** 或 **启动服务器**
4. 使用浏览器访问显示的 URL（如 `http://localhost:8080`）
5. 移动端可扫描二维码访问

## 界面介绍

### 规则列表页

显示所有已创建的规则，按媒体类型分组。

- **搜索**: 在搜索框输入关键词搜索规则
- **导入**: 从 JSON 文件导入规则（支持单个或批量）
- **导出全部**: 将所有规则导出为 JSON 文件
- **新建规则**: 创建新的爬虫规则

每个规则卡片显示：
- 规则名称和描述
- 媒体类型标签
- 标签
- 作者信息

### 规则编辑页

编辑页包含多个标签页：

1. **元数据** - 规则基本信息
2. **URL 匹配** - 定义规则匹配的 URL
3. **请求配置** - 自定义 HTTP 请求
4. **字段映射** - 定义数据提取字段
5. **分页配置** - 配置列表分页
6. **动作序列** - 前置/后置动作
7. **检测配置** - 反爬虫检测
8. **预览** - 页面预览和元素选择

## 创建规则

### 1. 填写元数据

| 字段 | 说明 |
|------|------|
| 规则名称 | 规则的显示名称 |
| 描述 | 规则的功能描述 |
| 媒体类型 | 选择 video/music/novel/comic/image 等 |
| 标签 | 添加标签便于分类 |
| 作者 | 规则作者 |

### 2. 配置 URL 匹配

#### 正则模式

输入正则表达式匹配 URL：
```
example\.com/video/\d+
```

#### Glob 模式

使用通配符匹配：
```
*.example.com/video/*
```

### 3. 配置请求（可选）

- **请求方法**: GET 或 POST
- **请求头**: 添加自定义请求头
- **Cookie**: 添加 Cookie
- **超时时间**: 请求超时时间（毫秒）
- **User-Agent**: 自定义 User-Agent

### 4. 配置字段映射

#### 列表提取

用于提取列表页数据（如视频列表、小说章节列表）：

1. 点击 **添加字段**
2. 输入字段名（如 `title`, `cover`, `url`）
3. 选择选择器类型（CSS/XPath/Regex）
4. 输入选择器表达式
5. 如需提取属性，填写属性名（如 `href`, `src`）

#### 详情提取

用于提取详情页数据：

1. 配置从列表页获取详情 URL 的选择器
2. 添加要提取的字段

#### 内容提取

用于提取实际媒体内容：

- **视频**: 播放地址、清晰度列表
- **漫画**: 图片列表
- **小说**: 章节内容
- **音乐**: 音频地址、歌词

### 5. 配置分页（可选）

支持三种分页方式：

#### URL 分页

使用 URL 模板：
```
/list/page/{page}
```

#### 点击分页

点击下一页按钮：
- 选择器: `.next-page`

#### 无限滚动

自动滚动加载更多：
- 滚动容器: `.content`
- 等待时间: 2000ms

### 6. 添加动作（可选）

#### 前置动作

在提取数据前执行：

- **等待**: 等待指定时间
- **点击**: 点击元素
- **滚动**: 滚动页面
- **填充**: 填充表单
- **脚本**: 执行 JavaScript

#### 后置动作

在提取数据后执行。

### 7. 配置检测（可选）

- **Cloudflare 检测**: 自动检测 Cloudflare 验证
- **验证码检测**: 检测 reCAPTCHA/hCaptcha
- **速率限制检测**: 检测 429/503 响应
- **自动重试**: 失败后自动重试

## 使用预览功能

### 打开预览

1. 切换到 **预览** 标签页
2. 输入要预览的 URL
3. 点击预览按钮

### 元素选择

1. 点击 **选择元素** 按钮
2. 在应用中点击要选择的元素
3. 选择器会自动填充到编辑器

### 选择器测试

1. 在测试面板输入选择器
2. 点击测试按钮
3. 查看匹配结果

## 导入/导出规则

### 导出单个规则

1. 在规则卡片上点击菜单按钮（···）
2. 选择 **导出**
3. JSON 文件会自动下载

### 导出所有规则

1. 点击 **导出全部** 按钮
2. 所有规则会打包为一个 JSON 文件下载

### 导入规则

1. 点击 **导入** 按钮
2. 选择 JSON 文件
3. 规则会自动导入

支持两种格式：
- 单个规则对象
- 包含 `rules` 数组的导出文件

## JSON 模式

高级用户可以直接编辑 JSON：

1. 点击 **JSON** 按钮切换模式
2. 在 Monaco 编辑器中编辑
3. 编辑器提供语法高亮和自动补全
4. 切换回表单模式会自动解析 JSON

## 验证规则

1. 点击 **验证** 按钮
2. 系统会检查规则完整性
3. 显示验证结果和错误信息

## 保存规则

1. 点击 **保存** 按钮
2. 规则会保存到数据库
3. 返回规则列表页

## 最佳实践

### 选择器编写

1. **优先使用 CSS 选择器**: 简单直观
2. **使用备用选择器**: 当主要选择器失效时使用
3. **避免过于具体**: 使用类名而非完整路径
4. **提取属性**: 图片用 `src`，链接用 `href`

### 性能优化

1. **限制分页数量**: 设置合理的 `maxPages`
2. **添加延迟**: 避免请求过快被封禁
3. **使用精确选择器**: 减少不必要的元素匹配

### 反爬虫处理

1. **添加随机延迟**: 模拟人类行为
2. **设置请求头**: 使用真实的 User-Agent
3. **启用检测配置**: 自动处理验证码和限制

## 常见问题

### Q: 规则不匹配 URL？

检查 URL 匹配配置：
- 正则表达式是否正确
- 是否需要转义特殊字符
- `fullUrl` 设置是否正确

### Q: 选择器提取不到数据？

1. 使用预览功能测试选择器
2. 检查页面是否需要登录
3. 检查页面是否动态加载内容

### Q: 无法连接服务器？

1. 确认服务器已启动
2. 检查防火墙设置
3. 移动端需要与电脑在同一局域网

### Q: 导入规则失败？

1. 检查 JSON 格式是否正确
2. 确保包含必要的字段（name, mediaType, match）
3. 检查是否与现有规则 ID 冲突
