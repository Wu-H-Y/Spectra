import{a as p,j as e,f as le,u as Me,d as ne,e as ce}from"./vendor-data-B2h88IjC.js";import{F as Ve}from"./vendor-editor-DvR7-QV0.js";import{t as M}from"./index-Cje_8L3Q.js";import{c as J,h as Ae,u as O,C as P,a as T,d as R,g as I,e as F,I as j,B as N,f as G,r as K,s as Ie}from"./input-BZXA1OJ3.js";import{o as xe,p as Je,V as Oe,q as he,r as Le,s as ae,t as De,u as pe,v as ze,w as me,x as Ue,j as re,y as _e,z as je,B as ve,E as fe,F as ge,G as ye,H as ie,J as Ne,X as ee,K as Z,M as $e,N as qe,Z as Be,Q as H,W as be,Y as We,_ as we,$ as Ce,a0 as Se}from"./vendor-ui-YtWZSjw-.js";import{u as Ke,d as Ge}from"./vendor-react-BDcrgNxs.js";const He=Ae("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),o=p.forwardRef(({className:s,...a},l)=>e.jsx(xe,{ref:l,className:J(He(),s),...a}));o.displayName=xe.displayName;const V=Je,A=Oe,S=p.forwardRef(({className:s,children:a,...l},r)=>e.jsxs(he,{ref:r,className:J("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),...l,children:[a,e.jsx(Le,{asChild:!0,children:e.jsx(ae,{className:"h-4 w-4 opacity-50"})})]}));S.displayName=he.displayName;const ke=p.forwardRef(({className:s,...a},l)=>e.jsx(je,{ref:l,className:J("flex cursor-default items-center justify-center py-1",s),...a,children:e.jsx(ve,{className:"h-4 w-4"})}));ke.displayName=je.displayName;const Pe=p.forwardRef(({className:s,...a},l)=>e.jsx(fe,{ref:l,className:J("flex cursor-default items-center justify-center py-1",s),...a,children:e.jsx(ae,{className:"h-4 w-4"})}));Pe.displayName=fe.displayName;const k=p.forwardRef(({className:s,children:a,position:l="popper",...r},i)=>e.jsx(De,{children:e.jsxs(pe,{ref:i,className:J("relative z-50 max-h-96 min-w-32 overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",l==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:l,...r,children:[e.jsx(ke,{}),e.jsx(ze,{className:J("p-1",l==="popper"&&"h-(--radix-select-trigger-height) w-full min-w-(--radix-select-trigger-width)"),children:a}),e.jsx(Pe,{})]})}));k.displayName=pe.displayName;const Qe=p.forwardRef(({className:s,...a},l)=>e.jsx(ge,{ref:l,className:J("py-1.5 pl-8 pr-2 text-sm font-semibold",s),...a}));Qe.displayName=ge.displayName;const g=p.forwardRef(({className:s,children:a,...l},r)=>e.jsxs(me,{ref:r,className:J("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-disabled:pointer-events-none data-disabled:opacity-50",s),...l,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ue,{children:e.jsx(re,{className:"h-4 w-4"})})}),e.jsx(_e,{children:a})]}));g.displayName=me.displayName;const Xe=p.forwardRef(({className:s,...a},l)=>e.jsx(ye,{ref:l,className:J("-mx-1 my-1 h-px bg-muted",s),...a}));Xe.displayName=ye.displayName;function Ze({serverUrl:s,previewUrl:a}){const{t:l}=O(),[r,i]=p.useState("css"),[d,h]=p.useState(""),[c,f]=p.useState(!1),[n,t]=p.useState(null),u=async()=>{if(!d.trim()){M.warning(l("preview.enterSelector"));return}if(!s){M.error(l("preview.serverNotRunning"));return}if(!a.trim()){M.warning(l("preview.openPreviewFirst"));return}f(!0),t(null);try{const x=await fetch(`${s}/api/preview/test-selector`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:a,selector:{type:r,expression:d}})});if(!x.ok)throw new Error("Failed to test selector");const v=await x.json();t(v),v.success&&v.count>0?M.success(l("preview.foundElements",{count:v.count})):v.success&&v.count===0&&M.warning(l("preview.noElementsFound"))}catch{M.error(l("preview.testError")),t({success:!1,count:0,elements:[],error:"Failed to test selector"})}finally{f(!1)}};return e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),l("preview.selectorTesting")]}),e.jsx(I,{children:l("preview.selectorTestingDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("preview.selector")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(V,{value:r,onValueChange:x=>i(x),children:[e.jsx(S,{className:"w-24 shrink-0",children:e.jsx(A,{})}),e.jsxs(k,{children:[e.jsx(g,{value:"css",children:"CSS"}),e.jsx(g,{value:"xpath",children:"XPath"}),e.jsx(g,{value:"regex",children:"Regex"}),e.jsx(g,{value:"jsonpath",children:"JSONPath"})]})]}),e.jsx(j,{value:d,onChange:x=>h(x.target.value),placeholder:r==="css"?".class or #id":r==="xpath"?"//div[@class]":r==="regex"?"pattern":"$.data",className:"flex-1 font-mono text-sm",onKeyDown:x=>x.key==="Enter"&&u()}),e.jsx(N,{onClick:u,disabled:c||!d.trim(),size:"icon",children:c?e.jsx(Ne,{className:"h-4 w-4 animate-spin"}):e.jsx(ie,{className:"h-4 w-4"})})]})]}),n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:n.success?e.jsxs(e.Fragment,{children:[e.jsxs(G,{variant:"outline",className:"bg-green-100 text-green-800",children:[e.jsx(re,{className:"h-3 w-3 mr-1"}),l("preview.success")]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:l("preview.elementsFound",{count:n.count})})]}):e.jsxs(G,{variant:"outline",className:"bg-red-100 text-red-800",children:[e.jsx(ee,{className:"h-3 w-3 mr-1"}),l("preview.failed")]})}),n.error&&e.jsx("p",{className:"text-sm text-destructive",children:n.error}),n.elements.length>0&&e.jsxs("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:[n.elements.slice(0,10).map((x,v)=>e.jsxs("div",{className:"p-2 bg-muted rounded text-sm",children:[e.jsxs("div",{className:"font-medium mb-1",children:[l("preview.element")," #",v+1]}),x.text&&e.jsxs("p",{className:"text-muted-foreground line-clamp-2 mb-1",children:['"',x.text,'"']}),e.jsxs("code",{className:"text-xs bg-background px-2 py-1 rounded block overflow-x-auto",children:[x.html.slice(0,200),x.html.length>200?"...":""]})]},v)),n.elements.length>10&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:l("preview.andMore",{count:n.elements.length-10})})]})]})]})]})}function Ye({serverUrl:s,isConnected:a,isSelecting:l,selectedElement:r,screenshot:i,onStartSelection:d,onCancelSelection:h,onClearSelection:c,onApplySelector:f,onRequestScreenshot:n}){const{t}=O(),[u,x]=p.useState(""),[v,b]=p.useState(!1),[y,L]=p.useState(!1),D=async()=>{if(!u.trim()){M.warning(t("preview.enterPreviewUrl"));return}if(!s){M.error(t("preview.serverNotRunning"));return}b(!0);try{if(!(await fetch(`${s}/api/preview/open`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:u})})).ok)throw new Error("Failed to open preview");M.success(t("preview.previewOpened"))}catch{M.error(t("preview.previewError"))}finally{b(!1)}},C=()=>{r&&(f(r.selector,r.selectorType),c(),M.success(t("preview.selectorApplied")))};return a?e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),t("preview.preview")]}),e.jsx(I,{children:t("preview.previewDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"preview-url",children:t("preview.previewUrl")}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{id:"preview-url",placeholder:"https://example.com",value:u,onChange:E=>x(E.target.value),onKeyDown:E=>E.key==="Enter"&&D()}),e.jsx(N,{onClick:D,disabled:v||!u.trim(),size:"icon",children:v?e.jsx(Ne,{className:"h-4 w-4 animate-spin"}):e.jsx(Z,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:t("preview.elementSelection")}),e.jsx("div",{className:"flex gap-2",children:l?e.jsx(e.Fragment,{children:e.jsxs(N,{variant:"destructive",size:"sm",onClick:h,className:"flex-1",children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),t("preview.cancelSelection")]})}):e.jsxs(N,{variant:"outline",size:"sm",onClick:d,className:"flex-1",disabled:!u.trim(),children:[e.jsx($e,{className:"h-4 w-4 mr-1"}),t("preview.selectElement")]})}),l&&e.jsx("p",{className:"text-xs text-muted-foreground",children:t("preview.selectingHint")})]}),r&&e.jsxs("div",{className:"space-y-2 p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:t("preview.selectedElement")}),e.jsx(N,{variant:"ghost",size:"sm",onClick:c,children:e.jsx(ee,{className:"h-3 w-3"})})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{variant:"outline",children:r.selectorType.toUpperCase()}),e.jsx("code",{className:"text-xs bg-background px-2 py-1 rounded flex-1 break-all",children:r.selector})]}),r.textContent&&e.jsxs("p",{className:"text-xs text-muted-foreground line-clamp-2",children:['"',r.textContent,'"']})]}),e.jsxs(N,{size:"sm",onClick:C,className:"w-full",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),t("preview.applySelector")]})]}),i&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(o,{children:t("preview.pageScreenshot")}),e.jsxs("div",{className:"flex gap-1",children:[n&&e.jsx(N,{variant:"ghost",size:"sm",onClick:n,title:t("preview.refreshScreenshot"),children:e.jsx(qe,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>L(!y),title:t("preview.toggleSize"),children:e.jsx(Be,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:`border rounded-lg overflow-hidden bg-muted ${y?"":"max-h-64"}`,children:e.jsx("img",{src:`data:image/png;base64,${i}`,alt:t("preview.pageScreenshot"),className:"w-full h-auto"})})]}),e.jsx(Ze,{serverUrl:s,previewUrl:u})]})]}):e.jsxs(P,{className:"border-yellow-500",children:[e.jsxs(T,{children:[e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),t("preview.preview")]}),e.jsx(I,{children:t("preview.previewNotConnected")})]}),e.jsx(F,{children:e.jsx(G,{variant:"secondary",children:t("preview.disconnected")})})]})}const es=[{value:"wait",label:"Wait",description:"Wait for a specified duration"},{value:"click",label:"Click",description:"Click on an element"},{value:"scroll",label:"Scroll",description:"Scroll the page or element"},{value:"fill",label:"Fill",description:"Fill in a form field"},{value:"script",label:"Script",description:"Execute JavaScript code"},{value:"condition",label:"Condition",description:"Conditional execution"},{value:"loop",label:"Loop",description:"Repeat actions"}];function ss({beforeActions:s,afterActions:a,onBeforeActionsChange:l,onAfterActionsChange:r}){const{t:i}=O(),d=n=>{const t={type:"wait",params:{duration:1e3}};n==="before"?l([...s,t]):r([...a,t])},h=(n,t)=>{n==="before"?l(s.filter((u,x)=>x!==t)):r(a.filter((u,x)=>x!==t))},c=(n,t,u)=>{const v=(n==="before"?s:a).map((b,y)=>y===t?{...b,...u}:b);n==="before"?l(v):r(v)},f=(n,t,u)=>{const x=n==="before"?[...s]:[...a],v=u==="up"?t-1:t+1;v<0||v>=x.length||([x[t],x[v]]=[x[v],x[t]],n==="before"?l(x):r(x))};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:i("rules.beforeActions")}),e.jsx(I,{children:i("rules.beforeActionsDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[s.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:i("rules.noBeforeActions")}):e.jsx("div",{className:"space-y-3",children:s.map((n,t)=>e.jsx(oe,{action:n,index:t,total:s.length,onChange:u=>c("before",t,u),onRemove:()=>h("before",t),onMove:u=>f("before",t,u)},t))}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>d("before"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),i("rules.addBeforeAction")]})]})]}),e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:i("rules.afterActions")}),e.jsx(I,{children:i("rules.afterActionsDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[a.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:i("rules.noAfterActions")}):e.jsx("div",{className:"space-y-3",children:a.map((n,t)=>e.jsx(oe,{action:n,index:t,total:a.length,onChange:u=>c("after",t,u),onRemove:()=>h("after",t),onMove:u=>f("after",t,u)},t))}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>d("after"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),i("rules.addAfterAction")]})]})]})]})}function oe({action:s,index:a,total:l,onChange:r,onRemove:i,onMove:d}){const{t:h}=O(),c=(n,t)=>{r({params:{...s.params,[n]:t}})},f=()=>{switch(s.type){case"wait":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.durationMs")}),e.jsx(j,{type:"number",min:0,value:s.params.duration||"",onChange:n=>c("duration",n.target.value?parseInt(n.target.value,10):0),placeholder:h("rules.durationPlaceholder")})]});case"click":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.selector")}),e.jsx(j,{value:s.params.selector||"",onChange:n=>c("selector",n.target.value),placeholder:h("rules.clickSelectorPlaceholder")})]});case"scroll":return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.scrollTo")}),e.jsxs(V,{value:s.params.scrollTo||"bottom",onValueChange:n=>c("scrollTo",n),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsxs(k,{children:[e.jsx(g,{value:"top",children:h("rules.scrollTop")}),e.jsx(g,{value:"bottom",children:h("rules.scrollBottom")}),e.jsx(g,{value:"element",children:h("rules.scrollElement")})]})]})]}),s.params.scrollTo==="element"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.scrollSelector")}),e.jsx(j,{value:s.params.selector||"",onChange:n=>c("selector",n.target.value),placeholder:h("rules.scrollSelectorPlaceholder")})]})]});case"fill":return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.fillSelector")}),e.jsx(j,{value:s.params.selector||"",onChange:n=>c("selector",n.target.value),placeholder:h("rules.fillSelectorPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.fillValue")}),e.jsx(j,{value:s.params.value||"",onChange:n=>c("value",n.target.value),placeholder:h("rules.fillValuePlaceholder")})]})]});case"script":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.scriptCode")}),e.jsx("textarea",{className:"flex min-h-25 w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",value:s.params.code||"",onChange:n=>c("code",n.target.value),placeholder:h("rules.scriptCodePlaceholder")})]});case"condition":return e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.conditionExpression")}),e.jsx(j,{value:s.params.condition||"",onChange:n=>c("condition",n.target.value),placeholder:h("rules.conditionPlaceholder")})]});case"loop":return e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.loopCount")}),e.jsx(j,{type:"number",min:1,value:s.params.count||"",onChange:n=>c("count",n.target.value?parseInt(n.target.value,10):1),placeholder:h("rules.loopCountPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{className:"text-xs",children:h("rules.loopDelay")}),e.jsx(j,{type:"number",min:0,value:s.params.delay||"",onChange:n=>c("delay",n.target.value?parseInt(n.target.value,10):0),placeholder:h("rules.loopDelayPlaceholder")})]})]});default:return null}};return e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["#",a+1]}),e.jsxs(V,{value:s.type,onValueChange:n=>r({type:n,params:{}}),children:[e.jsx(S,{className:"w-35",children:e.jsx(A,{})}),e.jsx(k,{children:es.map(n=>e.jsx(g,{value:n.value,children:n.label},n.value))})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>d("up"),disabled:a===0,children:e.jsx(ve,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>d("down"),disabled:a===l-1,children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx(N,{variant:"ghost",size:"icon",onClick:i,children:e.jsx(be,{className:"h-4 w-4 text-destructive"})})]})]}),f()]})}const se=[{value:"css",label:"CSS"},{value:"xpath",label:"XPath"},{value:"regex",label:"Regex"},{value:"jsonpath",label:"JSONPath"},{value:"js",label:"JavaScript"}];function ls({extract:s,onChange:a}){const{t:l}=O(),r=s?.list?.items||[],i=s?.detail?.items||[],d=t=>{a({...s,list:{...s?.list,container:s?.list?.container||{type:"css",expression:""},items:t}})},h=t=>{a({...s,detail:{...s?.detail,items:t}})},c=t=>{const u={field:"",selector:{type:"css",expression:""},required:!1};t==="list"?d([...r,u]):h([...i,u])},f=(t,u)=>{t==="list"?d(r.filter((x,v)=>v!==u)):h(i.filter((x,v)=>v!==u))},n=(t,u,x)=>{const b=(t==="list"?r:i).map((y,L)=>L===u?{...y,...x}:y);t==="list"?d(b):h(b)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:l("rules.listFields")}),e.jsx(I,{children:l("rules.listFieldsDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.containerSelector")}),e.jsxs("div",{className:"grid grid-cols-[120px_1fr] gap-2",children:[e.jsxs(V,{value:s?.list?.container?.type||"css",onValueChange:t=>a({...s,list:{...s?.list,container:{...s?.list?.container,type:t,expression:s?.list?.container?.expression||""},items:r}}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsx(k,{children:se.map(t=>e.jsx(g,{value:t.value,children:t.label},t.value))})]}),e.jsx(j,{value:s?.list?.container?.expression||"",onChange:t=>a({...s,list:{...s?.list,container:{type:s?.list?.container?.type||"css",expression:t.target.value},items:r}}),placeholder:l("rules.containerSelectorPlaceholder")})]})]}),e.jsx("div",{className:"space-y-3",children:r.map((t,u)=>e.jsx(de,{field:t,onChange:x=>n("list",u,x),onRemove:()=>f("list",u)},u))}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>c("list"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),l("rules.addListField")]})]})]}),e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:l("rules.detailFields")}),e.jsx(I,{children:l("rules.detailFieldsDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.detailUrlSelector")}),e.jsxs("div",{className:"grid grid-cols-[120px_1fr] gap-2",children:[e.jsxs(V,{value:s?.detail?.urlFromList?.type||"css",onValueChange:t=>a({...s,detail:{...s?.detail,urlFromList:{...s?.detail?.urlFromList,type:t,expression:s?.detail?.urlFromList?.expression||""},items:i}}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsx(k,{children:se.map(t=>e.jsx(g,{value:t.value,children:t.label},t.value))})]}),e.jsx(j,{value:s?.detail?.urlFromList?.expression||"",onChange:t=>a({...s,detail:{...s?.detail,urlFromList:{type:s?.detail?.urlFromList?.type||"css",expression:t.target.value},items:i}}),placeholder:l("rules.detailUrlSelectorPlaceholder")})]})]}),e.jsx("div",{className:"space-y-3",children:i.map((t,u)=>e.jsx(de,{field:t,onChange:x=>n("detail",u,x),onRemove:()=>f("detail",u)},u))}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>c("detail"),children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),l("rules.addDetailField")]})]})]})]})}function de({field:s,onChange:a,onRemove:l}){const{t:r}=O(),i=d=>{a({selector:{...s.selector,...d}})};return e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 grid grid-cols-[1fr_1fr] gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"text-xs",children:r("rules.fieldName")}),e.jsx(j,{value:s.field,onChange:d=>a({field:d.target.value}),placeholder:r("rules.fieldNamePlaceholder")})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"text-xs",children:r("rules.fieldDefaultValue")}),e.jsx(j,{value:s.defaultValue||"",onChange:d=>a({defaultValue:d.target.value}),placeholder:r("rules.fieldDefaultValuePlaceholder")})]})]}),e.jsx(N,{variant:"ghost",size:"icon",onClick:l,children:e.jsx(be,{className:"h-4 w-4 text-destructive"})})]}),e.jsxs("div",{className:"grid grid-cols-[120px_1fr_150px] gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"text-xs",children:r("rules.fieldType")}),e.jsxs(V,{value:s.selector.type,onValueChange:d=>i({type:d}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsx(k,{children:se.map(d=>e.jsx(g,{value:d.value,children:d.label},d.value))})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"text-xs",children:r("rules.expression")}),e.jsx(j,{value:s.selector.expression,onChange:d=>i({expression:d.target.value}),placeholder:r("rules.expressionPlaceholder")})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(o,{className:"text-xs",children:r("rules.attribute")}),e.jsx(j,{value:s.selector.attribute||"",onChange:d=>i({attribute:d.target.value||void 0}),placeholder:r("rules.attributePlaceholder")})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`required-${s.field}`,checked:s.required??!1,onChange:d=>a({required:d.target.checked}),className:"h-4 w-4"}),e.jsx(o,{htmlFor:`required-${s.field}`,className:"text-xs",children:r("rules.required")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:`firstOnly-${s.field}`,checked:s.selector.firstOnly??!1,onChange:d=>i({firstOnly:d.target.checked}),className:"h-4 w-4"}),e.jsx(o,{htmlFor:`firstOnly-${s.field}`,className:"text-xs",children:r("rules.firstOnly")})]})]})]})}const Y=[{value:"css",label:"CSS"},{value:"xpath",label:"XPath"},{value:"regex",label:"Regex"},{value:"jsonpath",label:"JSONPath"},{value:"js",label:"JavaScript"}];function as({pagination:s,onChange:a}){const{t:l}=O(),r=c=>{a({...s,...c})},i=c=>{r({nextSelector:{type:s?.nextSelector?.type||"css",expression:"",...s?.nextSelector,...c}})},d=c=>{r({clickSelector:{type:s?.clickSelector?.type||"css",expression:"",...s?.clickSelector,...c}})},h=c=>{r({scrollContainer:{type:s?.scrollContainer?.type||"css",expression:"",...s?.scrollContainer,...c}})};return e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:l("rules.paginationConfig")}),e.jsx(I,{children:l("rules.paginationConfigDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.paginationType")}),e.jsxs(V,{value:s?.type||"url",onValueChange:c=>r({type:c}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsxs(k,{children:[e.jsx(g,{value:"url",children:l("rules.paginationUrl")}),e.jsx(g,{value:"click",children:l("rules.paginationClick")}),e.jsx(g,{value:"infiniteScroll",children:l("rules.paginationInfiniteScroll")})]})]})]}),s?.type==="url"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.urlTemplate")}),e.jsx(j,{value:s.urlTemplate||"",onChange:c=>r({urlTemplate:c.target.value}),placeholder:l("rules.urlTemplatePlaceholder")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l("rules.urlTemplateHint")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.nextPageSelector")}),e.jsxs("div",{className:"grid grid-cols-[120px_1fr] gap-2",children:[e.jsxs(V,{value:s.nextSelector?.type||"css",onValueChange:c=>i({type:c}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsx(k,{children:Y.map(c=>e.jsx(g,{value:c.value,children:c.label},c.value))})]}),e.jsx(j,{value:s.nextSelector?.expression||"",onChange:c=>i({expression:c.target.value}),placeholder:l("rules.nextPageSelectorPlaceholder")})]})]})]}),s?.type==="click"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.clickSelector")}),e.jsxs("div",{className:"grid grid-cols-[120px_1fr] gap-2",children:[e.jsxs(V,{value:s.clickSelector?.type||"css",onValueChange:c=>d({type:c}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsx(k,{children:Y.map(c=>e.jsx(g,{value:c.value,children:c.label},c.value))})]}),e.jsx(j,{value:s.clickSelector?.expression||"",onChange:c=>d({expression:c.target.value}),placeholder:l("rules.clickSelectorPlaceholder")})]})]}),s?.type==="infiniteScroll"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.scrollContainer")}),e.jsxs("div",{className:"grid grid-cols-[120px_1fr] gap-2",children:[e.jsxs(V,{value:s.scrollContainer?.type||"css",onValueChange:c=>h({type:c}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsx(k,{children:Y.map(c=>e.jsx(g,{value:c.value,children:c.label},c.value))})]}),e.jsx(j,{value:s.scrollContainer?.expression||"",onChange:c=>h({expression:c.target.value}),placeholder:l("rules.scrollContainerPlaceholder")})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.maxPages")}),e.jsx(j,{type:"number",min:1,value:s?.maxPages||"",onChange:c=>r({maxPages:c.target.value?parseInt(c.target.value,10):void 0}),placeholder:l("rules.maxPagesPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.delayMs")}),e.jsx(j,{type:"number",min:0,value:s?.delayMs||"",onChange:c=>r({delayMs:c.target.value?parseInt(c.target.value,10):void 0}),placeholder:l("rules.delayMsPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.waitAfterLoadMs")}),e.jsx(j,{type:"number",min:0,value:s?.waitAfterLoadMs||"",onChange:c=>r({waitAfterLoadMs:c.target.value?parseInt(c.target.value,10):void 0}),placeholder:l("rules.waitAfterLoadMsPlaceholder")})]})]})]})]})}function rs({request:s={},onChange:a}){const{t:l}=O(),r=(i,d)=>{a({...s,[i]:d})};return e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:l("rules.requestConfiguration")}),e.jsx(I,{children:l("rules.requestConfigurationDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.method")}),e.jsxs(V,{value:s.method||"GET",onValueChange:i=>r("method",i),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsxs(k,{children:[e.jsx(g,{value:"GET",children:"GET"}),e.jsx(g,{value:"POST",children:"POST"}),e.jsx(g,{value:"PUT",children:"PUT"}),e.jsx(g,{value:"DELETE",children:"DELETE"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.timeout")}),e.jsx(j,{type:"number",value:s.timeoutMs||3e4,onChange:i=>r("timeoutMs",parseInt(i.target.value,10))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.userAgent")}),e.jsx(j,{value:s.userAgent||"",onChange:i=>r("userAgent",i.target.value),placeholder:l("rules.userAgentPlaceholder")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"mobileUserAgent",checked:s.mobileUserAgent??!1,onChange:i=>r("mobileUserAgent",i.target.checked),className:"h-4 w-4"}),e.jsx(o,{htmlFor:"mobileUserAgent",children:l("rules.mobileUserAgent")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.referer")}),e.jsx(j,{value:s.referer||"",onChange:i=>r("referer",i.target.value),placeholder:l("rules.refererPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.headers")}),e.jsx("textarea",{className:"flex min-h-25 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",value:JSON.stringify(s.headers||{},null,2),onChange:i=>{try{r("headers",JSON.parse(i.target.value))}catch{}},placeholder:'{"Header-Name": "Value"}'})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.cookies")}),e.jsx("textarea",{className:"flex min-h-25 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",value:JSON.stringify(s.cookies||{},null,2),onChange:i=>{try{r("cookies",JSON.parse(i.target.value))}catch{}},placeholder:'{"cookie_name": "value"}'})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"followRedirects",checked:s.followRedirects??!0,onChange:i=>r("followRedirects",i.target.checked),className:"h-4 w-4"}),e.jsx(o,{htmlFor:"followRedirects",children:l("rules.followRedirects")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.maxRedirects")}),e.jsx(j,{type:"number",value:s.maxRedirects||5,onChange:i=>r("maxRedirects",parseInt(i.target.value,10))})]})]})]})]})}const ts=[{value:"video"},{value:"music"},{value:"novel"},{value:"comic"},{value:"image"},{value:"audio"},{value:"rss"},{value:"generic"}],ns={video:"rules.mediaTypeVideo",music:"rules.mediaTypeMusic",novel:"rules.mediaTypeNovel",comic:"rules.mediaTypeComic",image:"rules.mediaTypeImage",audio:"rules.mediaTypeAudio",rss:"rules.mediaTypeRss",generic:"rules.mediaTypeGeneric"};function cs({rule:s,onChange:a}){const{t:l}=O();return e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:l("rules.ruleMetadata")}),e.jsx(I,{children:l("rules.ruleMetadataDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:"name",children:[l("rules.ruleName")," *"]}),e.jsx(j,{id:"name",value:s.name||"",onChange:r=>a({name:r.target.value}),placeholder:l("rules.ruleNamePlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"description",children:l("rules.ruleDescription")}),e.jsx(j,{id:"description",value:s.description||"",onChange:r=>a({description:r.target.value}),placeholder:l("rules.ruleDescriptionPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:"mediaType",children:[l("rules.mediaType")," *"]}),e.jsxs(V,{value:s.mediaType||"generic",onValueChange:r=>a({mediaType:r}),children:[e.jsx(S,{children:e.jsx(A,{placeholder:l("rules.selectMediaType")})}),e.jsx(k,{children:ts.map(r=>e.jsx(g,{value:r.value,children:l(ns[r.value])},r.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"author",children:l("common.author")}),e.jsx(j,{id:"author",value:s.author||"",onChange:r=>a({author:r.target.value}),placeholder:l("rules.authorPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"tags",children:l("rules.tags")}),e.jsx(j,{id:"tags",value:s.tags?.join(", ")||"",onChange:r=>a({tags:r.target.value.split(",").map(i=>i.trim()).filter(Boolean)}),placeholder:l("rules.tagsPlaceholder")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"enabled",checked:s.enabled??!0,onChange:r=>a({enabled:r.target.checked}),className:"h-4 w-4"}),e.jsx(o,{htmlFor:"enabled",children:l("rules.enabled")})]})]})]})}function is({match:s,onChange:a}){const{t:l}=O();return e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:l("rules.urlMatching")}),e.jsx(I,{children:l("rules.urlMatchingDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:"pattern",children:[l("rules.urlPattern")," *"]}),e.jsx(j,{id:"pattern",value:s.pattern,onChange:r=>a({...s,pattern:r.target.value}),placeholder:l("rules.urlPatternPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(o,{htmlFor:"patternType",children:[l("rules.patternType")," *"]}),e.jsxs(V,{value:s.type||"regex",onValueChange:r=>a({...s,type:r}),children:[e.jsx(S,{children:e.jsx(A,{})}),e.jsxs(k,{children:[e.jsx(g,{value:"regex",children:"Regular Expression"}),e.jsx(g,{value:"glob",children:"Glob Pattern"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"fullUrl",checked:s.fullUrl??!1,onChange:r=>a({...s,fullUrl:r.target.checked}),className:"h-4 w-4"}),e.jsx(o,{htmlFor:"fullUrl",children:l("rules.matchFullUrl")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.includePatterns")}),e.jsx("textarea",{className:"flex min-h-20 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:s.includePatterns?.join(`
`)||"",onChange:r=>a({...s,includePatterns:r.target.value.split(`
`).filter(Boolean)}),placeholder:l("rules.includePatternsPlaceholder")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{children:l("rules.excludePatterns")}),e.jsx("textarea",{className:"flex min-h-20 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:s.excludePatterns?.join(`
`)||"",onChange:r=>a({...s,excludePatterns:r.target.value.split(`
`).filter(Boolean)}),placeholder:l("rules.excludePatternsPlaceholder")})]})]})]})}const os=We,Te=p.forwardRef(({className:s,...a},l)=>e.jsx(we,{ref:l,className:J("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...a}));Te.displayName=we.displayName;const U=p.forwardRef(({className:s,...a},l)=>e.jsx(Ce,{ref:l,className:J("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",s),...a}));U.displayName=Ce.displayName;const _=p.forwardRef(({className:s,...a},l)=>e.jsx(Se,{ref:l,className:J("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...a}));_.displayName=Se.displayName;function ds(s){const{url:a,onMessage:l,onOpen:r,onClose:i,onError:d,autoReconnect:h=!0,reconnectDelay:c=3e3,maxReconnectAttempts:f=5}=s,[n,t]=p.useState(!1),[u,x]=p.useState(!1),[v,b]=p.useState(null),y=p.useRef(null),L=p.useRef(0),D=p.useRef(null),C=p.useRef(!0),E=p.useCallback(()=>{D.current&&(clearTimeout(D.current),D.current=null)},[]),q=p.useCallback(()=>{if(y.current?.readyState!==WebSocket.OPEN&&C.current){x(!0),b(null);try{const w=new WebSocket(a);y.current=w,w.onopen=()=>{C.current&&(t(!0),x(!1),b(null),L.current=0,w.send(JSON.stringify({type:"connect"})),r?.())},w.onmessage=B=>{if(C.current)try{const X=JSON.parse(B.data);l?.(X)}catch{console.error("Failed to parse WebSocket message:",B.data)}},w.onclose=()=>{C.current&&(t(!1),x(!1),i?.(),h&&L.current<f&&(L.current++,E(),D.current=setTimeout(()=>{C.current&&q()},c)))},w.onerror=B=>{C.current&&(x(!1),b("WebSocket connection error"),d?.(B))}}catch{if(!C.current)return;x(!1),b("Failed to create WebSocket connection")}}},[a,l,r,i,d,h,c,f,E]),Q=p.useCallback(()=>{E(),L.current=f,y.current&&(y.current.close(),y.current=null),t(!1),x(!1)},[E,f]),W=p.useCallback(w=>{y.current?.readyState===WebSocket.OPEN?y.current.send(JSON.stringify(w)):console.warn("WebSocket is not connected")},[]);return p.useEffect(()=>(C.current=!0,()=>{C.current=!1,E(),y.current&&(y.current.close(),y.current=null)}),[E]),{isConnected:n,isConnecting:u,error:v,send:W,connect:q,disconnect:Q}}function us(s){const[a,l]=p.useState(null),[r,i]=p.useState(!1),d=p.useCallback(y=>{switch(y.type){case"element_selected":l(y.data),i(!1);break;case"selection_started":i(!0);break;case"selection_cancelled":i(!1);break}},[]),h=s?s.replace("http://","ws://").replace("https://","wss://")+"/ws":"",{isConnected:c,send:f,connect:n,disconnect:t}=ds({url:h,onMessage:d,autoReconnect:!0}),u=p.useCallback(()=>{c&&(f({type:"start_selection"}),i(!0))},[c,f]),x=p.useCallback(()=>{c&&(f({type:"cancel_selection"}),i(!1))},[c,f]),v=p.useCallback(()=>{l(null)},[]),b=p.useCallback(()=>{c&&a&&f({type:"element_selected",data:a})},[c,f,a]);return{isConnected:c,isSelecting:r,selectedElement:a,startSelection:u,cancelSelection:x,clearSelection:v,sendSelectedElement:b,connect:n,disconnect:t}}le(s=>({rules:[],selectedRule:null,isLoading:!1,error:null,setRules:a=>s({rules:a}),selectRule:a=>s({selectedRule:a}),addRule:a=>s(l=>({rules:[...l.rules,a]})),updateRule:(a,l)=>s(r=>({rules:r.rules.map(i=>i.id===a?{...i,...l}:i)})),deleteRule:a=>s(l=>({rules:l.rules.filter(r=>r.id!==a)})),setLoading:a=>s({isLoading:a}),setError:a=>s({error:a})}));const xs=le(s=>({isJsonMode:!1,jsonValue:"",previewUrl:"",isPreviewVisible:!1,activeFieldPath:null,toggleJsonMode:()=>s(a=>({isJsonMode:!a.isJsonMode})),setJsonValue:a=>s({jsonValue:a}),setPreviewUrl:a=>s({previewUrl:a}),setPreviewVisible:a=>s({isPreviewVisible:a}),setActiveFieldPath:a=>s({activeFieldPath:a})})),ue=le(s=>({applyCallback:null,setApplyCallback:a=>s({applyCallback:a})}));function gs(){const{t:s}=O(),a=Ke(),{id:l}=Ge(),r=Me(),i=l==="new",{isJsonMode:d,jsonValue:h,toggleJsonMode:c,setJsonValue:f}=xs(),[n,t]=p.useState({name:"",description:"",mediaType:"generic",match:{pattern:"",type:"regex"},request:{},extract:{},beforeActions:[],afterActions:[],tags:[],enabled:!0}),{data:u}=ne({queryKey:["server","status"],queryFn:Ie.status,refetchInterval:5e3}),{isConnected:x,isSelecting:v,selectedElement:b,startSelection:y,cancelSelection:L,clearSelection:D,connect:C}=us(u?.url||null);p.useEffect(()=>{u?.isRunning&&C()},[u?.isRunning,C]);const{setApplyCallback:E}=ue(),{data:q,isLoading:Q}=ne({queryKey:["rules",l],queryFn:()=>K.get(l),enabled:!i&&!!l});q&&!n.id&&(t(q),f(JSON.stringify(q,null,2)));const W=ce({mutationFn:m=>i?K.create(m):K.update(l,m),onSuccess:()=>{r.invalidateQueries({queryKey:["rules"]}),a("/rules")}}),w=ce({mutationFn:m=>K.validate(m)}),B=()=>{const m=d?JSON.parse(h):n;W.mutate(m)},X=()=>{const m=d?JSON.parse(h):n;w.mutate(m)},Re=m=>{if(m!==void 0){f(m);try{const $=JSON.parse(m);t($)}catch{}}},z=m=>{const $={...n,...m};t($),f(JSON.stringify($,null,2))},Fe=(m,$)=>{const Ee={type:$,expression:m},{applyCallback:te}=ue.getState();te?(te(Ee),E(null),M.success(s("preview.selectorApplied"))):M.success(s("preview.selectorCopied"))};return Q?e.jsx("div",{className:"flex items-center justify-center min-h-100",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:s(i?"common.newRule":"rules.editRule")}),e.jsx("p",{className:"text-muted-foreground",children:s(i?"rules.createNewRule":"rules.editRuleDescription")})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{variant:"outline",onClick:()=>a("/rules"),children:s("common.cancel")}),e.jsx(N,{variant:"outline",onClick:X,children:s("rules.validate")}),e.jsx(N,{onClick:B,disabled:W.isPending,children:s("common.save")})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{variant:d?"outline":"default",size:"sm",onClick:()=>c(),children:s("rules.formMode")}),e.jsx(N,{variant:d?"default":"outline",size:"sm",onClick:()=>c(),children:"JSON"})]}),d?e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:"JSON Editor"}),e.jsx(I,{children:s("rules.jsonEditorDescription")})]}),e.jsx(F,{children:e.jsx(Ve,{height:"600px",defaultLanguage:"json",value:h,onChange:Re,options:{minimap:{enabled:!1},fontSize:14,lineNumbers:"on",scrollBeyondLastLine:!1,automaticLayout:!0}})})]}):e.jsxs(os,{defaultValue:"metadata",className:"space-y-4",children:[e.jsxs(Te,{className:"grid w-full grid-cols-8",children:[e.jsx(U,{value:"metadata",children:s("rules.metadata")}),e.jsx(U,{value:"url",children:s("rules.urlMatching")}),e.jsx(U,{value:"request",children:s("rules.request")}),e.jsx(U,{value:"fields",children:s("rules.fields")}),e.jsx(U,{value:"pagination",children:s("rules.pagination")}),e.jsx(U,{value:"actions",children:s("rules.actions")}),e.jsx(U,{value:"detection",children:s("rules.detection")}),e.jsx(U,{value:"preview",children:s("preview.preview")})]}),e.jsx(_,{value:"metadata",children:e.jsx(cs,{rule:n,onChange:m=>z(m)})}),e.jsx(_,{value:"url",children:e.jsx(is,{match:n.match,onChange:m=>z({match:m})})}),e.jsx(_,{value:"request",children:e.jsx(rs,{request:n.request,onChange:m=>z({request:m})})}),e.jsx(_,{value:"fields",children:e.jsx(ls,{extract:n.extract,onChange:m=>z({extract:m})})}),e.jsx(_,{value:"pagination",children:e.jsx(as,{pagination:n.extract?.list?.pagination,onChange:m=>z({extract:{...n.extract,list:{...n.extract?.list,container:n.extract?.list?.container||{type:"css",expression:""},items:n.extract?.list?.items||[],pagination:m}}})})}),e.jsx(_,{value:"actions",children:e.jsx(ss,{beforeActions:n.beforeActions||[],afterActions:n.afterActions||[],onBeforeActionsChange:m=>z({beforeActions:m}),onAfterActionsChange:m=>z({afterActions:m})})}),e.jsx(_,{value:"detection",children:e.jsxs(P,{children:[e.jsxs(T,{children:[e.jsx(R,{children:s("rules.detectionConfig")}),e.jsx(I,{children:s("rules.detectionConfigDescription")})]}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"detectCloudflare",checked:n.detection?.detectCloudflare??!0,onChange:m=>z({detection:{...n.detection,detectCloudflare:m.target.checked}}),className:"h-4 w-4"}),e.jsx(o,{htmlFor:"detectCloudflare",children:s("rules.detectCloudflare")})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",id:"autoRetry",checked:n.detection?.autoRetry??!0,onChange:m=>z({detection:{...n.detection,autoRetry:m.target.checked}}),className:"h-4 w-4"}),e.jsx(o,{htmlFor:"autoRetry",children:s("rules.autoRetry")})]})]})]})}),e.jsx(_,{value:"preview",children:e.jsx(Ye,{serverUrl:u?.url||null,isConnected:x,isSelecting:v,selectedElement:b,onStartSelection:y,onCancelSelection:L,onClearSelection:D,onApplySelector:Fe})})]}),w.data&&e.jsxs(P,{className:w.data.valid?"border-green-500":"border-red-500",children:[e.jsx(T,{children:e.jsx(R,{children:w.data.valid?s("rules.validationPassed"):s("rules.validationFailed")})}),w.data.errors.length>0&&e.jsx(F,{children:e.jsx("ul",{className:"list-disc pl-5 space-y-1",children:w.data.errors.map((m,$)=>e.jsxs("li",{className:"text-sm text-destructive",children:[e.jsxs("span",{className:"font-mono",children:[m.path,":"]})," ",m.message]},$))})})]})]})}export{gs as RuleEditorPage,gs as default};
